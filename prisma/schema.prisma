// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Veranstaltung (Event) - die jährliche Veranstaltung
model Event {
  id          String   @id @default(cuid())
  name        String
  year        Int      @unique
  startDate   DateTime
  endDate     DateTime
  location    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants Participant[]
  rooms        Room[]
  workshops    Workshop[]
}

// Teilnehmer
model Participant {
  id            String          @id @default(cuid())
  firstName     String
  lastName      String
  email         String?
  phone         String?
  street        String?
  houseNumber   String?
  postalCode    String?
  city          String?
  notes         String?

  // Rolle: REGULAR (normal), HELPER (Helfer), ABI (Abi-Gast)
  role          String @default("REGULAR")

  // Zahlungsstatus
  hasPaid       Boolean         @default(false)
  paidAmount    Float?
  paidAt        DateTime?
  paymentMethod String?         // "CASH" (Bar) oder "TRANSFER" (Überweisung)

  // Check-in Status
  checkedIn     Boolean         @default(false)
  checkedInAt   DateTime?

  // Geburtsdatum
  birthDate     DateTime?

  // Ankunfts- und Abreisedatum innerhalb der Veranstaltung
  arrivalDate   DateTime?
  departureDate DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Beziehungen
  eventId       String
  event         Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)

  roomId        String?
  room          Room?           @relation(fields: [roomId], references: [id], onDelete: SetNull)

  // Workshop-Beziehungen
  workshopLeader      WorkshopLeader[]
  workshopParticipant WorkshopParticipant[]

  @@index([eventId])
  @@index([roomId])
  @@index([city])
}

// Zimmer
model Room {
  id          String   @id @default(cuid())
  name        String
  floor       Int?
  capacity    Int
  category    String?  // z.B. "4BN", "3BNB" (behindertengerecht), etc.
  location    String?  // Lage: RH (Rhein), ST (Straße), SCH (Schönburg), H (Hof), P (Persohof)
  building    String?  // Gebäudeflügel: S (Süden), W (Westen), N (Norden)
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Beziehungen
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  participants Participant[]
  workshops    Workshop[]

  @@unique([eventId, name])
  @@index([eventId])
}

// Admin User für Authentifizierung
model AdminUser {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Workshop
model Workshop {
  id          String   @id @default(cuid())
  name        String
  description String?
  maxParticipants Int  @default(30)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Beziehungen
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // Raum in dem der Workshop stattfindet
  roomId      String?
  room        Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)

  // Betreuer (ABIs)
  leaders     WorkshopLeader[]

  // Teilnehmer
  participants WorkshopParticipant[]

  @@unique([eventId, name])
  @@index([eventId])
  @@index([roomId])
}

// Workshop-Betreuer (ABIs)
model WorkshopLeader {
  id          String   @id @default(cuid())

  workshopId  String
  workshop    Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([workshopId, participantId])
  @@index([workshopId])
  @@index([participantId])
}

// Workshop-Teilnehmer
model WorkshopParticipant {
  id          String   @id @default(cuid())

  workshopId  String
  workshop    Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([workshopId, participantId])
  @@index([workshopId])
  @@index([participantId])
}
